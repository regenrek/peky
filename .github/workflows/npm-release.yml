name: npm Release

on:
  workflow_run:
    workflows: ["release"]
    types: [completed]
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (vX.Y.Z)"
        required: true
        type: string

concurrency:
  group: npm-release-${{ inputs.tag || github.event.workflow_run.head_branch }}
  cancel-in-progress: false

jobs:
  publish:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'push' && github.event.workflow_run.head_repository.full_name == github.repository && startsWith(github.event.workflow_run.head_branch, 'v')) }}
    permissions:
      contents: read
      id-token: write
    env:
      TAG: ${{ inputs.tag || github.event.workflow_run.head_branch }}
      NPM_CONFIG_USERCONFIG: ${{ runner.temp }}/npmrc
      NODE_AUTH_TOKEN: ""
      NPM_TOKEN: ""
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.TAG }}
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Prepare npm config (OIDC-only)
        run: |
          set -euo pipefail

          cat >"${NPM_CONFIG_USERCONFIG}" <<'EOF'
          registry=https://registry.npmjs.org/
          always-auth=false
          EOF

          echo "node: $(node --version)"
          echo "npm: $(npm --version)"

          if [[ -z "${ACTIONS_ID_TOKEN_REQUEST_URL:-}" ]]; then
            echo "missing GitHub OIDC token endpoint (permissions: id-token: write required)" >&2
            exit 1
          fi

          if [[ -n "${NODE_AUTH_TOKEN:-}" ]] || [[ -n "${NPM_TOKEN:-}" ]]; then
            echo "refusing to publish with npm auth tokens; remove npm token secrets and use npm Trusted Publishing (OIDC)" >&2
            exit 1
          fi

          if grep -q "_authToken" "${NPM_CONFIG_USERCONFIG}"; then
            echo "refusing to publish with _authToken in npm config; expected OIDC-only" >&2
            exit 1
          fi

      - name: Build npm packages from GitHub release assets
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          version="${TAG#v}"
          if [[ -z "$version" || "$version" == "$TAG" ]]; then
            echo "unexpected tag format: $TAG (expected vX.Y.Z)" >&2
            exit 1
          fi

          rm -rf dist packages
          mkdir -p dist

          fetch_one() {
            local os="$1"
            local arch="$2"
            local archive="peky_${version}_${os}_${arch}.tar.gz"

            gh release download "$TAG" --repo "$GITHUB_REPOSITORY" --pattern "$archive"

            local tmp
            tmp="$(mktemp -d)"
            tar -xzf "$archive" -C "$tmp"

            local bin
            bin="$(find "$tmp" -type f -name peky | LC_ALL=C sort | head -n 1)"
            if [[ -z "$bin" ]]; then
              echo "missing peky binary in $archive" >&2
              exit 1
            fi

            local out="dist/peky_${os}_${arch}/peky"
            mkdir -p "$(dirname "$out")"
            cp "$bin" "$out"
            chmod +x "$out" >/dev/null 2>&1 || true

            rm -rf "$tmp" "$archive"
          }

          fetch_one darwin amd64
          fetch_one darwin arm64
          fetch_one linux amd64
          fetch_one linux arm64

          VERSION="$version" node scripts/build-npm-packages

      - name: Publish platform packages (OIDC)
        run: |
          set -euo pipefail

          shopt -s nullglob
          platform_dirs=(packages/peakypanes-*)
          if (( ${#platform_dirs[@]} == 0 )); then
            echo "no platform packages found under packages/" >&2
            exit 1
          fi

          IFS=$'\n' platform_dirs=($(printf "%s\n" "${platform_dirs[@]}" | LC_ALL=C sort))
          for dir in "${platform_dirs[@]}"; do
            echo "Publishing $dir"
            (cd "$dir" && npm publish --access public --provenance)
          done

      - name: Publish meta package (OIDC)
        run: |
          set -euo pipefail
          (cd packages/peakypanes && npm publish --access public --provenance)
