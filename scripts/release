#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'USAGE'
Usage: scripts/release X.Y.Z [--allow-branch] [--dry-run]

Runs the full release flow:
- validates repo state
- runs tests (always)
- tags and pushes
- triggers the GitHub Actions release workflow (GoReleaser + Homebrew tap update + npm publish)
USAGE
}

die() {
  echo "release: $*" >&2
  exit 1
}

if [[ ${1:-} == "-h" || ${1:-} == "--help" || ${1:-} == "" ]]; then
  usage
  exit 1
fi

version_raw=$1
shift
allow_branch=false
dry_run=false
for arg in "$@"; do
  case "$arg" in
    --allow-branch) allow_branch=true ;;
    --dry-run|-n) dry_run=true ;;
    *) die "unknown flag: $arg" ;;
  esac
done

version=${version_raw#v}
if ! [[ $version =~ ^[0-9]+\.[0-9]+\.[0-9]+([.-][0-9A-Za-z.-]+)?$ ]]; then
  die "invalid version '$version_raw' (expected X.Y.Z)"
fi

tag="v$version"

if ! command -v git >/dev/null 2>&1; then die "git not found"; fi
if ! command -v go >/dev/null 2>&1; then die "go not found"; fi

if [[ -n $(git status --porcelain) ]]; then
  if [[ $dry_run == true ]]; then
    echo "warning: working tree not clean"
  else
    die "working tree not clean. Commit or stash changes first."
  fi
fi

branch=$(git rev-parse --abbrev-ref HEAD)
if [[ $allow_branch == false && $branch != "main" ]]; then
  if [[ $dry_run == true ]]; then
    echo "warning: current branch is '$branch' (expected 'main')"
  else
    die "current branch is '$branch'. Switch to 'main' or pass --allow-branch."
  fi
fi

if [[ ! -f CHANGELOG.md ]]; then
  die "CHANGELOG.md missing"
fi
if ! grep -q "^## ${version}\\b" CHANGELOG.md; then
  if [[ $dry_run == true ]]; then
    echo "warning: CHANGELOG.md missing '## ${version}' section"
  else
    die "CHANGELOG.md must include a '## ${version}' section"
  fi
fi

if git rev-parse "$tag" >/dev/null 2>&1; then
  if [[ $dry_run == true ]]; then
    echo "warning: tag already exists: $tag"
  else
    die "tag already exists: $tag"
  fi
fi

run() {
  if [[ $dry_run == true ]]; then
    echo "+ $*"
    return 0
  fi
  "$@"
}

printf "Running tests...\n"
go test ./...

printf "Creating tag %s...\n" "$tag"
run git tag "$tag"
run git push origin HEAD --tags

printf "Release triggered: %s\n" "$tag"
printf "Monitor GitHub Actions: workflow 'release' (GoReleaser + Homebrew tap update), then 'npm Release'.\n"
