#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'USAGE'
Usage: scripts/update-homebrew-tap vX.Y.Z

Updates the Homebrew tap formula in regenrek/homebrew-tap for the given tag by:
- computing the sha256 of the source archive for that tag
- writing Formula/peakypanes.rb
- committing and pushing to the tap repo

Required environment variables:
- TAP_PUSH_TOKEN: GitHub token with write access to regenrek/homebrew-tap

Optional environment variables:
- TAP_REPO: default "regenrek/homebrew-tap"
- TAP_BRANCH: default "main"
- TAP_GIT_AUTHOR_NAME: default "homebrew-tap-publish[bot]"
- TAP_GIT_AUTHOR_EMAIL: default "homebrew-tap-publish[bot]@users.noreply.github.com"
USAGE
}

die() {
  echo "update-homebrew-tap: $*" >&2
  exit 1
}

if [[ ${1:-} == "-h" || ${1:-} == "--help" || ${1:-} == "" ]]; then
  usage
  exit 1
fi

tag=$1
if ! [[ $tag =~ ^v[0-9]+\.[0-9]+\.[0-9]+([.-][0-9A-Za-z.-]+)?$ ]]; then
  die "invalid tag '$tag' (expected vX.Y.Z)"
fi

if [[ -z ${TAP_PUSH_TOKEN:-} ]]; then
  die "TAP_PUSH_TOKEN is required"
fi

tap_repo=${TAP_REPO:-regenrek/homebrew-tap}
tap_branch=${TAP_BRANCH:-main}
tap_git_author_name=${TAP_GIT_AUTHOR_NAME:-homebrew-tap-publish[bot]}
tap_git_author_email=${TAP_GIT_AUTHOR_EMAIL:-homebrew-tap-publish[bot]@users.noreply.github.com}

if ! [[ $tap_repo =~ ^[A-Za-z0-9_.-]+/[A-Za-z0-9_.-]+$ ]]; then
  die "invalid TAP_REPO '$tap_repo' (expected owner/repo)"
fi
if ! [[ $tap_branch =~ ^[A-Za-z0-9_.-]+$ ]]; then
  die "invalid TAP_BRANCH '$tap_branch'"
fi
if ! [[ $tap_git_author_name =~ ^[[:print:]]+$ ]]; then
  die "invalid TAP_GIT_AUTHOR_NAME"
fi
if ! [[ $tap_git_author_email =~ ^[^[:space:]@]+@[^[:space:]@]+$ ]]; then
  die "invalid TAP_GIT_AUTHOR_EMAIL"
fi

version=${tag#v}
tarball_url="https://github.com/regenrek/peakypanes/archive/refs/tags/${tag}.tar.gz"

if ! command -v curl >/dev/null 2>&1; then die "curl not found"; fi
if ! command -v shasum >/dev/null 2>&1; then die "shasum not found"; fi
if ! command -v base64 >/dev/null 2>&1; then die "base64 not found"; fi
if ! command -v git >/dev/null 2>&1; then die "git not found"; fi

sha256=$(
  curl -fsSL --max-time 120 "$tarball_url" \
    | shasum -a 256 \
    | awk '{print $1}'
)
if [[ -z $sha256 ]]; then
  die "failed to compute sha256 for $tarball_url"
fi

tmp=$(mktemp -d)
cleanup() { rm -rf "$tmp"; }
trap cleanup EXIT

auth_header_value=$(printf "x-access-token:%s" "$TAP_PUSH_TOKEN" | base64 | tr -d '\n')

git -c "http.https://github.com/.extraheader=AUTHORIZATION: basic ${auth_header_value}" \
  clone --quiet --branch "$tap_branch" --depth 1 "https://github.com/${tap_repo}.git" "$tmp/tap"

formula_path="$tmp/tap/Formula/peakypanes.rb"
mkdir -p "$(dirname "$formula_path")"

cat >"$formula_path" <<EOF
class Peakypanes < Formula
  desc "Terminal dashboard with YAML-based layouts and native live previews."
  homepage "https://github.com/regenrek/peakypanes"
  url "$tarball_url"
  sha256 "$sha256"
  depends_on "go" => :build

  def install
    ldflags = "-s -w -X main.version=${version}"
    system "go", "build", *std_go_args(ldflags: ldflags), "./cmd/peakypanes"
  end

  test do
    system "#{bin}/peakypanes", "--version"
  end
end
EOF

if git -C "$tmp/tap" diff --quiet; then
  echo "update-homebrew-tap: no changes needed (${tag})"
  exit 0
fi

git -C "$tmp/tap" add "Formula/peakypanes.rb"

git -C "$tmp/tap" -c user.name="$tap_git_author_name" -c user.email="$tap_git_author_email" \
  commit -m "peakypanes ${tag}" >/dev/null

git -C "$tmp/tap" -c "http.https://github.com/.extraheader=AUTHORIZATION: basic ${auth_header_value}" \
  push --quiet origin "HEAD:${tap_branch}"

echo "update-homebrew-tap: updated ${tap_repo}@${tap_branch} (${tag})"
