#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'USAGE'
Usage: scripts/update-homebrew-tap vX.Y.Z

Updates the Homebrew tap formula in regenrek/homebrew-tap for the given tag by:
- computing the sha256 of the source archive for that tag
- writing Formula/peakypanes.rb
- committing via the GitHub Contents API

Required environment variables:
- TAP_PUSH_TOKEN: GitHub token with write access to regenrek/homebrew-tap

Optional environment variables:
- TAP_REPO: default "regenrek/homebrew-tap"
- TAP_BRANCH: default "main"
- TAP_GIT_AUTHOR_NAME: default "homebrew-tap-publish[bot]"
- TAP_GIT_AUTHOR_EMAIL: default "homebrew-tap-publish[bot]@users.noreply.github.com"
USAGE
}

die() {
  echo "update-homebrew-tap: $*" >&2
  exit 1
}

if [[ ${1:-} == "-h" || ${1:-} == "--help" || ${1:-} == "" ]]; then
  usage
  exit 1
fi

tag=$1
if ! [[ $tag =~ ^v[0-9]+\.[0-9]+\.[0-9]+([.-][0-9A-Za-z.-]+)?$ ]]; then
  die "invalid tag '$tag' (expected vX.Y.Z)"
fi

if [[ -z ${TAP_PUSH_TOKEN:-} ]]; then
  die "TAP_PUSH_TOKEN is required"
fi

tap_repo=${TAP_REPO:-regenrek/homebrew-tap}
tap_branch=${TAP_BRANCH:-main}
tap_git_author_name=${TAP_GIT_AUTHOR_NAME:-homebrew-tap-publish[bot]}
tap_git_author_email=${TAP_GIT_AUTHOR_EMAIL:-homebrew-tap-publish[bot]@users.noreply.github.com}

if ! [[ $tap_repo =~ ^[A-Za-z0-9_.-]+/[A-Za-z0-9_.-]+$ ]]; then
  die "invalid TAP_REPO '$tap_repo' (expected owner/repo)"
fi
if ! [[ $tap_branch =~ ^[A-Za-z0-9_.-]+$ ]]; then
  die "invalid TAP_BRANCH '$tap_branch'"
fi
if ! [[ $tap_git_author_name =~ ^[[:print:]]+$ ]]; then
  die "invalid TAP_GIT_AUTHOR_NAME"
fi
if ! [[ $tap_git_author_email =~ ^[^[:space:]@]+@[^[:space:]@]+$ ]]; then
  die "invalid TAP_GIT_AUTHOR_EMAIL"
fi

version=${tag#v}
tarball_url="https://github.com/regenrek/peakypanes/archive/refs/tags/${tag}.tar.gz"

if ! command -v curl >/dev/null 2>&1; then die "curl not found"; fi
if ! command -v shasum >/dev/null 2>&1; then die "shasum not found"; fi
if ! command -v base64 >/dev/null 2>&1; then die "base64 not found"; fi
if ! command -v gh >/dev/null 2>&1; then die "gh not found"; fi

base64_decode() {
  if base64 --help 2>/dev/null | grep -q -- '--decode'; then
    base64 --decode
    return
  fi
  base64 -D
}

sha256=$(
  curl -fsSL --max-time 120 "$tarball_url" \
    | shasum -a 256 \
    | awk '{print $1}'
)
if [[ -z $sha256 ]]; then
  die "failed to compute sha256 for $tarball_url"
fi

tmp=$(mktemp -d)
cleanup() { rm -rf "$tmp"; }
trap cleanup EXIT

export GH_TOKEN="$TAP_PUSH_TOKEN"

formula_path="$tmp/peakypanes.rb"
mkdir -p "$(dirname "$formula_path")"

cat >"$formula_path" <<EOF
class Peakypanes < Formula
  desc "Terminal dashboard with YAML-based layouts and native live previews"
  homepage "https://github.com/regenrek/peakypanes"
  url "$tarball_url"
  sha256 "$sha256"
  depends_on "go" => :build

  def install
    ldflags = "-s -w -X main.version=${version}"
    system "go", "build", *std_go_args(ldflags: ldflags, output: bin/"peky"), "./cmd/peky"
    system "go", "build", *std_go_args(ldflags: ldflags, output: bin/"peakypanes"), "./cmd/peakypanes"
  end

  service do
    run [opt_bin/"peakypanes", "daemon"]
    keep_alive true
    working_dir HOMEBREW_PREFIX
    log_path var/"log/peakypanes.log"
    error_log_path var/"log/peakypanes.log"
  end

  def caveats
    <<~EOS
      Peakypanes runs a background daemon for managing sessions.

      Start the daemon:
        brew services start peakypanes

      Then run:
        peakypanes
    EOS
  end

  test do
    system "#{bin}/peky", "--version"
    system "#{bin}/peakypanes", "--version"
  end
end
EOF

desc_line=$(grep -E '^  desc ' "$formula_path" || true)
if [[ $desc_line =~ \"\.$ ]]; then
  die "formula desc ends with a period"
fi

tap_path="Formula/peakypanes.rb"
remote_sha=""
remote_content=""
if remote_sha=$(gh api -H "Accept: application/vnd.github+json" "repos/${tap_repo}/contents/${tap_path}?ref=${tap_branch}" --jq '.sha' 2>/dev/null); then
  remote_content_b64=$(gh api -H "Accept: application/vnd.github+json" "repos/${tap_repo}/contents/${tap_path}?ref=${tap_branch}" --jq '.content' 2>/dev/null || true)
  if [[ -n ${remote_content_b64:-} ]]; then
    remote_content=$(printf '%s' "$remote_content_b64" | tr -d '\n' | base64_decode)
  fi
fi

desired=$(cat "$formula_path")
if [[ -n $remote_content && $remote_content == "$desired" ]]; then
  echo "update-homebrew-tap: no changes needed (${tag})"
  exit 0
fi

content_b64=$(base64 <"$formula_path" | tr -d '\n')

put_args=(
  -H "Accept: application/vnd.github+json"
  -f "message=peakypanes ${tag}"
  -f "content=${content_b64}"
  -f "branch=${tap_branch}"
  -f "committer[name]=${tap_git_author_name}"
  -f "committer[email]=${tap_git_author_email}"
  -f "author[name]=${tap_git_author_name}"
  -f "author[email]=${tap_git_author_email}"
)
if [[ -n $remote_sha ]]; then
  put_args+=(-f "sha=${remote_sha}")
fi

if ! gh api --method PUT "repos/${tap_repo}/contents/${tap_path}" "${put_args[@]}" >/dev/null; then
  die "failed to update ${tap_repo}@${tap_branch} (${tag}); token likely missing Contents write permission for the tap repo"
fi

echo "update-homebrew-tap: updated ${tap_repo}@${tap_branch} (${tag})"
