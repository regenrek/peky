#!/usr/bin/env bash
set -euo pipefail

if [[ ${1:-} == "-h" || ${1:-} == "--help" ]]; then
  cat <<'USAGE'
Usage: scripts/dev-run [args...]

Installs peakypanes, restarts the daemon, and opens the UI in a fresh Ghostty
window. Any args are forwarded to the peakypanes command.

Examples:
  scripts/dev-run
  scripts/dev-run start --layout dev-3
USAGE
  exit 0
fi

if [[ "$(uname -s)" != "Darwin" ]]; then
  echo "dev-run: Ghostty launch is only supported on macOS." >&2
  exit 1
fi

if [[ ! -d "/Applications/Ghostty.app" ]]; then
  echo "dev-run: Ghostty.app not found in /Applications." >&2
  exit 1
fi

repo_root="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

gobin="${GOBIN:-}"
if [[ -z "$gobin" ]]; then
  gobin="$(go env GOPATH)/bin"
fi

peak_bin="${gobin}/peakypanes"
log_file="${DEV_RUN_LOG:-/tmp/peakypanes-dev-run-inner.log}"

args_escaped=()
for arg in "$@"; do
  args_escaped+=("$(printf '%q' "$arg")")
done
args_joined=""
if [[ ${#args_escaped[@]} -gt 0 ]]; then
  args_joined="${args_escaped[*]}"
fi

cmd=$(printf 'set -euo pipefail; log=%q; : >"$log"; echo "dev-run started $(date)" >>"$log"; echo "repo: %q" >>"$log"; cd %q; export GOBIN=%q; export PATH=%q:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:${PATH:-}; export TERM=xterm-256color; export COLORTERM=truecolor; unset NO_COLOR; mkdir -p %q; { go install ./cmd/peakypanes; %q daemon restart -y; } >>"$log" 2>&1; %q %s; status=$?; if [[ $status -ne 0 ]]; then echo "dev-run failed ($status). Log: $log"; echo "Press Enter to close..."; read -r _; fi' \
  "$log_file" "$repo_root" "$repo_root" "$gobin" "$gobin" "$gobin" "$peak_bin" "$peak_bin" "$args_joined")

open -na Ghostty.app --args -e /bin/bash -lc "$cmd"
