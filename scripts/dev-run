#!/usr/bin/env bash
set -euo pipefail

debug_events=""
daemon_log=""
debug_log=""

args=()
while [[ $# -gt 0 ]]; do
  case "$1" in
    --debug-events)
      debug_events="1"
      shift
      ;;
    --daemon-log)
      if [[ -z ${2:-} ]]; then
        echo "error: --daemon-log requires a path" >&2
        exit 1
      fi
      daemon_log="$2"
      shift 2
      ;;
    --debug-log)
      if [[ -z ${2:-} ]]; then
        echo "error: --debug-log requires a path" >&2
        exit 1
      fi
      debug_log="$2"
      shift 2
      ;;
    --)
      shift
      args+=("$@")
      break
      ;;
    *)
      args+=("$1")
      shift
      ;;
  esac
done
if ((${#args[@]})); then
  set -- "${args[@]}"
else
  set --
fi

if [[ ${1:-} == "-h" || ${1:-} == "--help" ]]; then
  cat <<'USAGE'
Usage: scripts/dev-run [flags] [args...]

Installs peakypanes, restarts the daemon, and opens the UI in a fresh Ghostty
window. Any args are forwarded to the peakypanes command.

Examples:
  scripts/dev-run
  scripts/dev-run start --layout auto
  scripts/dev-run --debug-events
  scripts/dev-run --debug-events --daemon-log /tmp/peakypanes-daemon.log
  scripts/dev-run --debug-events --debug-log /tmp/peakypanes-ui.log

Flags:
  --debug-events    Enable debug event logs (PEAKYPANES_DEBUG_EVENTS=1)
  --daemon-log PATH Override daemon log file used by auto-started daemon
  --debug-log PATH  Write debug event logs to a file
USAGE
  exit 0
fi

if [[ "$(uname -s)" != "Darwin" ]]; then
  echo "dev-run: Ghostty launch is only supported on macOS." >&2
  exit 1
fi

if [[ ! -d "/Applications/Ghostty.app" ]]; then
  echo "dev-run: Ghostty.app not found in /Applications." >&2
  exit 1
fi

repo_root="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

gobin="${GOBIN:-}"
if [[ -z "$gobin" ]]; then
  gobin="$(go env GOPATH)/bin"
fi

peak_bin="${gobin}/peakypanes"
log_file="${DEV_RUN_LOG:-/tmp/peakypanes-dev-run-inner.log}"

if [[ -n "$debug_events" ]]; then
  if [[ -z "$daemon_log" ]]; then
    daemon_log="/tmp/peakypanes-daemon.log"
  fi
  if [[ -z "$debug_log" ]]; then
    debug_log="/tmp/peakypanes-ui.log"
  fi
fi

env_exports=""
if [[ -n "$debug_events" ]]; then
  env_exports+="export PEAKYPANES_DEBUG_EVENTS=1; "
fi
if [[ -n "$daemon_log" ]]; then
  env_exports+="export PEAKYPANES_LOG_FILE=$(printf %q "$daemon_log"); "
fi
if [[ -n "$debug_log" ]]; then
  env_exports+="export PEAKYPANES_DEBUG_EVENTS_LOG=$(printf %q "$debug_log"); "
fi

args_escaped=()
for arg in "$@"; do
  args_escaped+=("$(printf '%q' "$arg")")
done
args_joined=""
if [[ ${#args_escaped[@]} -gt 0 ]]; then
  args_joined="${args_escaped[*]}"
fi

cmd=$(printf 'set -euo pipefail; log=%q; : >"$log"; echo "dev-run started $(date)" >>"$log"; echo "repo: %q" >>"$log"; cd %q; export GOBIN=%q; export PATH=%q:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:${PATH:-}; export TERM=xterm-256color; export COLORTERM=truecolor; unset NO_COLOR; %s mkdir -p %q; { go install ./cmd/peakypanes; %q daemon restart -y; } >>"$log" 2>&1; %q %s; status=$?; if [[ $status -ne 0 ]]; then echo "dev-run failed ($status). Log: $log"; echo "Press Enter to close..."; read -r _; fi' \
  "$log_file" "$repo_root" "$repo_root" "$gobin" "$gobin" "$env_exports" "$gobin" "$peak_bin" "$peak_bin" "$args_joined")

open -na Ghostty.app --args -e /bin/bash -lc "$cmd"
