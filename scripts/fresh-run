#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'USAGE'
Usage: scripts/fresh-run [version] [--with-project] [--cmd <args...>]

Runs peky from npm in a clean HOME/XDG_CONFIG_HOME so it behaves like a
fresh install. By default it runs the dashboard in a temp project directory.

Options:
  version        npm tag or version to run (default: latest)
  --with-project create a .peky.yml in the temp project
  --cmd          custom command after version (e.g. "start --layout auto")

Examples:
  scripts/fresh-run
  scripts/fresh-run latest
  scripts/fresh-run latest --with-project
  scripts/fresh-run latest --cmd "start --layout auto"
USAGE
}

version="latest"
with_project=false
custom_cmd=""

if [[ ${1:-} == "-h" || ${1:-} == "--help" ]]; then
  usage
  exit 0
fi

if [[ ${1:-} != "" && ${1:-} != --* ]]; then
  version=$1
  shift
fi

while [[ $# -gt 0 ]]; do
  case "$1" in
    --with-project)
      with_project=true
      shift
      ;;
    --cmd)
      shift
      custom_cmd=${1:-""}
      if [[ -z "$custom_cmd" ]]; then
        echo "fresh-run: --cmd requires an argument" >&2
        exit 1
      fi
      shift
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      echo "fresh-run: unknown flag $1" >&2
      exit 1
      ;;
  esac
done

TMP_HOME="$(mktemp -d)"
TMP_PROJ="$(mktemp -d)"
mkdir -p "$TMP_HOME/.config"

if [[ $with_project == true ]]; then
  cat > "$TMP_PROJ/.peky.yml" <<'YAML'
session: demo
layout:
  grid: 2x2
  commands:
    - ""
    - ""
    - ""
    - ""
YAML
fi

cmd=("npx" "-y" "-p" "peky@${version}" "peky")
if [[ -n "$custom_cmd" ]]; then
  # shellcheck disable=SC2206
  cmd+=( $custom_cmd )
fi

printf "\nFresh run environment\n"
printf "  HOME=%s\n" "$TMP_HOME"
printf "  XDG_CONFIG_HOME=%s\n" "$TMP_HOME/.config"
printf "  PROJECT=%s\n" "$TMP_PROJ"
if [[ $with_project == true ]]; then
  printf "  project config: %s/.peky.yml\n" "$TMP_PROJ"
fi
printf "\nRunning: %s\n\n" "${cmd[*]}"

(
  export HOME="$TMP_HOME"
  export XDG_CONFIG_HOME="$TMP_HOME/.config"
  cd "$TMP_PROJ"
  "${cmd[@]}"
)
