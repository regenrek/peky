#!/usr/bin/env bash
set -euo pipefail

bin=${DEVWATCH_BIN:-./devwatch}
debug_events=""
daemon_log=""
debug_log=""

args=()
while [[ $# -gt 0 ]]; do
  case "$1" in
    --debug-events)
      debug_events="1"
      shift
      ;;
    --daemon-log)
      if [[ -z ${2:-} ]]; then
        echo "error: --daemon-log requires a path" >&2
        exit 1
      fi
      daemon_log="$2"
      shift 2
      ;;
    --debug-log)
      if [[ -z ${2:-} ]]; then
        echo "error: --debug-log requires a path" >&2
        exit 1
      fi
      debug_log="$2"
      shift 2
      ;;
    --)
      shift
      args+=("$@")
      break
      ;;
    *)
      args+=("$1")
      shift
      ;;
  esac
done
if ((${#args[@]})); then
  set -- "${args[@]}"
else
  set --
fi

if [[ ${1:-} == "-h" || ${1:-} == "--help" ]]; then
  cat <<'USAGE'
Usage: scripts/dev-watch [flags] [-- args...]

Hot-reload peakypanes on file changes using the in-repo watcher.
Pass any args after -- to forward to peakypanes.

Examples:
  scripts/dev-watch
  scripts/dev-watch -- --layout dev-3
  scripts/dev-watch --watch cmd,internal -- --layout dev-3
  scripts/dev-watch --debug-events
  scripts/dev-watch --debug-events --daemon-log /tmp/peakypanes-daemon.log
  scripts/dev-watch --debug-events --debug-log /tmp/peakypanes-ui.log

Flags:
  --debug-events    Enable debug event logs (PEAKYPANES_DEBUG_EVENTS=1)
  --daemon-log PATH Override daemon log path used by auto-started daemon
  --debug-log PATH  Write debug event logs to a file
USAGE
  exit 0
fi

if [[ -n "$debug_events" ]]; then
  export PEAKYPANES_DEBUG_EVENTS=1
  if [[ -z "$daemon_log" ]]; then
    daemon_log="/tmp/peakypanes-daemon.log"
  fi
  if [[ -z "$debug_log" ]]; then
    debug_log="/tmp/peakypanes-ui.log"
  fi
fi
if [[ -n "$daemon_log" ]]; then
  export PEAKYPANES_LOG_FILE="$daemon_log"
fi
if [[ -n "$debug_log" ]]; then
  export PEAKYPANES_DEBUG_EVENTS_LOG="$debug_log"
fi

go build -o "$bin" ./cmd/devwatch
exec "$bin" "$@"
